import streamlit as st  # å¯¼å…¥Streamlitåº“ï¼Œç”¨äºæ„å»ºWebåº”ç”¨
import pickle  # å¯¼å…¥pickleåº“ï¼Œç”¨äºåŠ è½½ä¿å­˜çš„æ¨¡å‹å’Œæ•°æ®
import pandas as pd  # å¯¼å…¥pandasåº“ï¼Œç”¨äºæ•°æ®å¤„ç†

# è®¾ç½®é¡µé¢çš„æ ‡é¢˜ã€å›¾æ ‡å’Œå¸ƒå±€
st.set_page_config(
    page_title="ä¼é¹…åˆ†ç±»å™¨",  # è®¾ç½®é¡µé¢æ ‡é¢˜
    page_icon=":penguin:",  # è®¾ç½®é¡µé¢å›¾æ ‡ï¼ˆä¼é¹…emojiï¼‰
    layout='wide',  # è®¾ç½®é¡µé¢å¸ƒå±€ä¸ºå®½å±æ¨¡å¼
)

# ä½¿ç”¨ä¾§è¾¹æ å®ç°å¤šé¡µé¢æ˜¾ç¤ºæ•ˆæœ
with st.sidebar:
    st.image('rigth_logo.png', width=100)  # åœ¨ä¾§è¾¹æ æ˜¾ç¤ºlogoå›¾ç‰‡ï¼Œå®½åº¦ä¸º100åƒç´ 
    st.title('ğŸ§ ä¼é¹…åˆ†ç±»å™¨')  # åœ¨ä¾§è¾¹æ æ˜¾ç¤ºæ ‡é¢˜ï¼Œå¸¦ä¼é¹…emoji
    st.divider()  # åœ¨ä¾§è¾¹æ æ·»åŠ åˆ†éš”çº¿
    page = st.selectbox("è¯·é€‰æ‹©é¡µé¢", ["ç®€ä»‹é¡µé¢", "é¢„æµ‹åˆ†ç±»é¡µé¢"])  # åˆ›å»ºé¡µé¢é€‰æ‹©ä¸‹æ‹‰æ¡†

# å¦‚æœé€‰æ‹©"ç®€ä»‹é¡µé¢"
if page == "ç®€ä»‹é¡µé¢":
    st.title("ä¼é¹…åˆ†ç±»å™¨ :penguin:")  # æ˜¾ç¤ºä¸»æ ‡é¢˜ï¼Œå¸¦ä¼é¹…emoji
    st.divider()  # æ·»åŠ åˆ†éš”çº¿
    st.header('ğŸ“Š æ•°æ®é›†ä»‹ç»')  # æ˜¾ç¤º"æ•°æ®é›†ä»‹ç»"å°æ ‡é¢˜ï¼Œå¸¦å›¾è¡¨emoji
    # ä½¿ç”¨infoä¿¡æ¯æ¡†æ˜¾ç¤ºæ•°æ®é›†è¯¦ç»†ä»‹ç»
    st.info("""*å¸•å°”é»˜ç¾¤å²›ä¼é¹…æ•°æ®é›†æ˜¯ç”¨äºæ•°æ®æ¢ç´¢å’Œæ•°æ®å¯è§†åŒ–çš„ä¸€ä¸ªå‡ºè‰²çš„æ•°æ®é›†,
ä¹Ÿå¯ä»¥ä½œä¸ºæœºå™¨å­¦ä¹ å…¥é—¨ç»ƒä¹ ã€‚
è¯¥æ•°æ®é›†æ˜¯ç”±Gormanç­‰æ”¶é›†,å¹¶å‘å¸ƒåœ¨ä¸€ä¸ªåä¸º palmerpenguins çš„Rè¯­è¨€åŒ…,
ä»¥å¯¹å—æä¼é¹…ç§ç±»è¿›è¡Œåˆ†ç±»å’Œç ”ç©¶ã€‚
è¯¥æ•°æ®é›†è®°å½•äº†344è¡Œè§‚æµ‹æ•°æ®,åŒ…å«3ä¸ªä¸åŒç‰©ç§çš„ä¼é¹…:é˜¿å¾·åˆ©ä¼é¹…ã€å·´å¸ƒäºšä¼
é¹…å’Œå¸½å¸¦ä¼é¹…çš„å„ç§ä¿¡æ¯ã€‚""")
    st.header('ğŸ§ ä¸‰ç§ä¼é¹…çš„å¡é€šå›¾åƒ')  # æ˜¾ç¤º"ä¸‰ç§ä¼é¹…çš„å¡é€šå›¾åƒ"å°æ ‡é¢˜ï¼Œå¸¦ä¼é¹…emoji
    st.image('penguins.png', width=600)  # æ˜¾ç¤ºä¼é¹…å¡é€šå›¾åƒï¼Œè®¾ç½®å®½åº¦ä¸º600åƒç´ 

# å¦‚æœé€‰æ‹©"é¢„æµ‹åˆ†ç±»é¡µé¢"
elif page == "é¢„æµ‹åˆ†ç±»é¡µé¢":
    st.title("ğŸ” é¢„æµ‹ä¼é¹…åˆ†ç±»")  # æ˜¾ç¤ºä¸»æ ‡é¢˜ï¼Œå¸¦æ”¾å¤§é•œemoji
    # ä½¿ç”¨infoä¿¡æ¯æ¡†æ˜¾ç¤ºåº”ç”¨åŠŸèƒ½ä»‹ç»
    st.info("è¿™ä¸ªWebåº”ç”¨æ˜¯åŸºäºå¸•å°”é»˜ç¾¤å²›ä¼é¹…æ•°æ®é›†æ„å»ºçš„æ¨¡å‹ã€‚åªéœ€è¾“å…¥6ä¸ªä¿¡æ¯."
                "å°±å¯ä»¥é¢„æµ‹ä¼é¹…çš„ç‰©ç§ï¼Œä½¿ç”¨ä¸‹é¢çš„è¡¨å•å¼€å§‹é¢„æµ‹å§ï¼")
    # ä½¿ç”¨3:1:2çš„åˆ—å¸ƒå±€åˆ›å»ºä¸‰åˆ—
    col_form, col, col_logo = st.columns((3, 1, 2))
    # åœ¨ç¬¬ä¸€åˆ—ï¼ˆè¡¨å•åˆ—ï¼‰ä¸­åˆ›å»ºå†…å®¹
    with col_form:
        # ä½¿ç”¨è¡¨å•ç»„ä»¶åŒ…è£¹è¾“å…¥å­—æ®µ
        with st.form('user_inputs'):
            st.subheader("ğŸ“ ä¼é¹…ç‰¹å¾ä¿¡æ¯")  # è¡¨å•å†…å°æ ‡é¢˜ï¼Œå¸¦æ–‡ä»¶emoji
            # åˆ›å»ºä¸¤ä¸ªå­åˆ—ï¼Œç”¨äºå¹¶æ’æ˜¾ç¤ºè¾“å…¥å­—æ®µ
            col1, col2 = st.columns(2)
            with col1:
                # åˆ›å»ºå²›å±¿é€‰æ‹©ä¸‹æ‹‰æ¡†
                island = st.selectbox('ä¼é¹…æ –æ¯çš„å²›å±¿', options=['æ‰˜å°”æ£®å²›', 'æ¯”æ–¯ç§‘ç¾¤å²›', 'å¾·é‡Œå§†å²›'])
                # åˆ›å»ºæ€§åˆ«é€‰æ‹©ä¸‹æ‹‰æ¡†
                sex = st.selectbox("æ€§åˆ«", options=['é›„æ€§', 'é›Œæ€§'])
            with col2:
                # åˆ›å»ºå–™é•¿åº¦è¾“å…¥æ¡†ï¼Œæœ€å°å€¼ä¸º0
                bill_length = st.number_input("å–™çš„é•¿åº¦(æ¯«ç±³)", min_value=0.0)
                # åˆ›å»ºå–™æ·±åº¦è¾“å…¥æ¡†ï¼Œæœ€å°å€¼ä¸º0
                bill_depth = st.number_input("å–™çš„æ·±åº¦(æ¯«ç±³)", min_value=0.0)
            st.divider()  # è¡¨å•å†…æ·»åŠ åˆ†éš”çº¿
            st.subheader("ğŸ“ èº«ä½“æµ‹é‡æ•°æ®")  # è¡¨å•å†…å°æ ‡é¢˜ï¼Œå¸¦å°ºå­emoji
            # åˆ›å»ºä¸¤ä¸ªå­åˆ—ï¼Œç”¨äºå¹¶æ’æ˜¾ç¤ºèº«ä½“æµ‹é‡æ•°æ®è¾“å…¥å­—æ®µ
            col3, col4 = st.columns(2)
            with col3:
                # åˆ›å»ºç¿…è†€é•¿åº¦è¾“å…¥æ¡†ï¼Œæœ€å°å€¼ä¸º0
                flipper_length = st.number_input("ç¿…è†€çš„é•¿åº¦(æ¯«ç±³)", min_value=0.0)
            with col4:
                # åˆ›å»ºèº«ä½“è´¨é‡è¾“å…¥æ¡†ï¼Œæœ€å°å€¼ä¸º0
                body_mass = st.number_input('èº«ä½“è´¨é‡(å…‹)', min_value=0.0)
            st.divider()  # è¡¨å•å†…æ·»åŠ åˆ†éš”çº¿
            # åˆ›å»ºæäº¤æŒ‰é’®ï¼Œè®¾ç½®ä¸ºå…¨å®½ã€ä¸»è¦æ ·å¼ï¼Œå¸¦æ”¾å¤§é•œemoji
            submitted = st.form_submit_button('ğŸ” é¢„æµ‹åˆ†ç±»', use_container_width=True, type='primary')

        # åˆå§‹åŒ–ä¸å²›å±¿ç›¸å…³çš„è™šæ‹Ÿå˜é‡ï¼ˆç”¨äºæ¨¡å‹è¾“å…¥ï¼‰
        island_biscoe, island_dream, island_torgerson = 0, 0, 0
        # æ ¹æ®ç”¨æˆ·é€‰æ‹©çš„å²›å±¿è®¾ç½®å¯¹åº”è™šæ‹Ÿå˜é‡çš„å€¼
        if island == 'æ¯”æ–¯ç§‘ç¾¤å²›':
            island_biscoe = 1
        elif island == 'å¾·é‡Œå§†å²›':
            island_dream = 1
        elif island == 'æ‰˜å°”æ£®å²›':
            island_torgerson = 1

        # åˆå§‹åŒ–ä¸æ€§åˆ«ç›¸å…³çš„è™šæ‹Ÿå˜é‡ï¼ˆç”¨äºæ¨¡å‹è¾“å…¥ï¼‰
        sex_female, sex_male = 0, 0
        # æ ¹æ®ç”¨æˆ·é€‰æ‹©çš„æ€§åˆ«è®¾ç½®å¯¹åº”è™šæ‹Ÿå˜é‡çš„å€¼
        if sex == 'é›Œæ€§':
            sex_female = 1
        elif sex == 'é›„æ€§':
            sex_male = 1

        # å°†æ‰€æœ‰è¾“å…¥ç‰¹å¾ç»„åˆæˆä¸€ä¸ªåˆ—è¡¨ï¼Œç”¨äºæ¨¡å‹é¢„æµ‹
        format_data = [bill_length, bill_depth, flipper_length, body_mass,
                      island_dream, island_torgerson, island_biscoe, sex_male,
                      sex_female]

    # ä½¿ç”¨pickleä»ç£ç›˜åŠ è½½ä¹‹å‰ä¿å­˜çš„éšæœºæ£®æ—æ¨¡å‹
    with open('rfc_model.pkl', 'rb') as f:
        rfc_model = pickle.load(f)

    # ä½¿ç”¨pickleä»ç£ç›˜åŠ è½½ä¹‹å‰ä¿å­˜çš„ç‰©ç§åç§°æ˜ å°„
    with open('output_uniques.pkl', 'rb') as f:
        output_uniques_map = pickle.load(f)

    # å¦‚æœç”¨æˆ·ç‚¹å‡»äº†æäº¤æŒ‰é’®
    if submitted:
        # å°†è¾“å…¥æ•°æ®è½¬æ¢ä¸ºDataFrameæ ¼å¼ï¼Œä½¿ç”¨æ¨¡å‹æœŸæœ›çš„ç‰¹å¾åç§°
        format_data_df = pd.DataFrame(data=[format_data], columns=rfc_model.feature_names_in_)
        # ä½¿ç”¨æ¨¡å‹å¯¹è¾“å…¥æ•°æ®è¿›è¡Œé¢„æµ‹ï¼Œå¾—åˆ°é¢„æµ‹çš„ç±»åˆ«ä»£ç 
        predict_result_code = rfc_model.predict(format_data_df)
        # å°†ç±»åˆ«ä»£ç æ˜ å°„åˆ°å…·ä½“çš„ç‰©ç§åç§°
        predict_result_species = output_uniques_map[predict_result_code[0]]
        # ä½¿ç”¨successæˆåŠŸæ¶ˆæ¯æ¡†æ˜¾ç¤ºé¢„æµ‹ç»“æœï¼Œå¸¦é¶å¿ƒemoji
        st.success(f'ğŸ¯ æ ¹æ®æ‚¨è¾“å…¥çš„æ•°æ®ï¼Œé¢„æµ‹è¯¥ä¼é¹…çš„ç‰©ç§åç§°æ˜¯: **{predict_result_species}**')

    # åœ¨ç¬¬ä¸‰åˆ—ï¼ˆç»“æœå±•ç¤ºåˆ—ï¼‰ä¸­åˆ›å»ºå†…å®¹
    with col_logo:
        st.subheader("ğŸ“Š ç»“æœå±•ç¤º")  # æ˜¾ç¤ºå°æ ‡é¢˜ï¼Œå¸¦å›¾è¡¨emoji
        # å¦‚æœç”¨æˆ·æœªæäº¤æ•°æ®
        if not submitted:
            st.info("ç­‰å¾…è¾“å…¥æ•°æ®...")  # æ˜¾ç¤ºç­‰å¾…ä¿¡æ¯
            st.image('rigth_logo.png', width=300)  # æ˜¾ç¤ºlogoå›¾ç‰‡
        # å¦‚æœç”¨æˆ·å·²æäº¤æ•°æ®
        else:
            st.success(f"é¢„æµ‹ç»“æœ: {predict_result_species}")  # æ˜¾ç¤ºé¢„æµ‹ç»“æœ
            st.image(f'{predict_result_species}.png', width=300)  # æ˜¾ç¤ºå¯¹åº”ç‰©ç§çš„å›¾ç‰‡